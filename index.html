<!DOCTYPE html>
<html>
    <head>
        <title>SGJCH15</title>
        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        <script src="entity.js"></script>
        <script src="type.js"></script>
        <script src="world.js"></script>
        <script src="action.js"></script>
        <script src="drawmap.js"></script>
    </head>
    <body>
        <canvas width="800" height="600" id="gameCanvas"></canvas>
        <script>

/** THE GAME ITSELF **********************************************************/

// Game state:
var w = new World(50);
var player = null;
var started = false;

w.fill([0.8, typeMap['grass'], 100, typeMap['rock']]);
w.add(new Entity(new Type("player", "black", true, {}, function(e, world){
    var neighbours = world.getNeighbours(e);
    var grass = neighbours.filter(function (n) {
        return n.get('x') == e.get('x') && n.get('y') == e.get('y') && n.type.name == 'grass';
    });
    if (grass.length > 0) {
        grass = grass[0];
        return [new ActionType('plant', false, '', 'new flower'), e, grass];
    }
    return null;
}, function(){}), {'x': 7, 'y': 3}));

function advanceWorld() {
    player = null;
    while (!player) {
        var advanceResult = w.advance();

        if (advanceResult instanceof Entity) {
            player = advanceResult;
            var playerAction = player.type.tick(player, w);
            if (playerAction && isActionAllowed(playerAction, w)) {
                runAction(playerAction, w);
            }
        } else {
            if (confirm(getActionDescription(advanceResult))) {
                runAction(advanceResult, w);
            }
        }
    }
}

function getActionDescription(action) {
    return action[0].name + ' ' + action[1].type.name + ' (' + action[0].srcChanges + ') ' + action[2].type.name + ' (' + action[0].trgChanges + ')';
}

function input(msSinceLastUpdate) {
    if (!started) {
        advanceWorld();
        started = true;
    }
    for (var i = 0; i < directions.length; i++) {
        var d = directions[i];
        if (rawKeys[d[0]]) {
            var action = [moveActionTypes[i], player, w.tileAt(player.get('x') + d[1], player.get('y') + d[2])];
            if (isActionAllowed(action, w)) {
                runAction(action, w);
                advanceWorld();
            }
            rawKeys[d[0]] = false;
            break;
        }
    }
}

function update(msSinceLastUpdate) {}

function draw() {
    drawMap(c, w, 0, 0);
}


/** THE GAME "ENGINE" ********************************************************/
var canvas = document.getElementById("gameCanvas");
var c = canvas.getContext("2d");
var keys = {};
var rawKeys = {};
var click = null;

var UP = 38;
var DOWN = 40;
var LEFT = 37;
var RIGHT = 39;

var directions = [
    [UP, 0, -1], [DOWN, 0, 1], [LEFT, -1, 0], [RIGHT, 1, 0]
];

// Listen for key presses.
function canvasKeyDown(e) {
    keys[String.fromCharCode(e.which)] = true;
    rawKeys[e.which] = true;
}

function canvasKeyUp(e) {
    keys[String.fromCharCode(e.which)] = false;
    rawKeys[e.which] = false;
}

$('body').keydown(canvasKeyDown);
$('body').keyup(canvasKeyUp);

// Listen for clicks.
function canvasClick(e) {
    click = { "x": e.offsetX, "y": e.offsetY };
}

$('#gameCanvas').click(canvasClick);

// Set up game loop.
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
var lastUpdate = new Date().getTime();

function nextFrame() {
    var currentTime = new Date().getTime();
    input(currentTime - lastUpdate);
    click = null;
    update(currentTime - lastUpdate);
    draw();
    lastUpdate = currentTime;
    requestAnimationFrame(nextFrame);
}

// Once everything is set up, start game loop.
requestAnimationFrame(nextFrame);
        </script>
    </body>
</html>
