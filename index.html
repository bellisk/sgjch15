<!DOCTYPE html>
<html>
    <head>
        <title>SGJCH15</title>
        <script src="jquery/jquery-1.11.0.min.js"></script>
        <script src="jquery/jquery-migrate-1.2.1.min.js"></script>
        <script src="entity.js"></script>
        <script src="type.js"></script>
        <script src="world.js"></script>
        <script src="action.js"></script>
        <script src="drawmap.js"></script>
        <script src="mapgen.js"></script>
    </head>
    <body style="background: #222222;">
        <div style="margin: 0 auto; width: 800px;"><canvas width="800" height="600" id="gameCanvas"></canvas></div>
        <script>

/** THE GAME ITSELF **********************************************************/

// Game state:
var w = new World(50);
mapgen(w);
var player = null;
var started = false;

/*var fillTypes = new Array();
var fraction = 1.0 / types.length + 0.01;
types.forEach(function(t) {
    fillTypes.push(fraction);
    fillTypes.push(t);
});

w.fill(fillTypes);*/
var thePlayer = new Entity(new Type("player", "player", true, {}), {'x': 7, 'y': 3});
w.add(thePlayer);

function advanceWorld() {
    player = null;
    while (!player) {
        var advanceResult = w.advance();

        if (advanceResult instanceof Entity) {
            player = advanceResult;
            var playerAction = player.type.tick(player, w);
            if (playerAction && isActionAllowed(playerAction, w)) {
                runAction(playerAction, w);
            }
        } else {
            if (confirm(getActionDescription(advanceResult))) {
                runAction(advanceResult, w);
            }
        }
    }
}

function getActionDescription(action) {
    return action[0].name + ' ' + action[1].type.name + ' (' + action[0].srcChanges + ') ' + action[2].type.name + ' (' + action[0].trgChanges + ')';
}

function input(msSinceLastUpdate) {
    if (!started) {
        advanceWorld();
        started = true;
    }
    for (var i = 0; i < directions.length; i++) {
        var d = directions[i];
        if (rawKeys[d[0]]) {
            var action = [moveActionTypes[i], player, w.tileAt(player.get('x') + d[1], player.get('y') + d[2])];
            if (isActionAllowed(action, w)) {
                runAction(action, w);
                advanceWorld();
            }
            rawKeys[d[0]] = false;
            break;
        }
    }
}

function update(msSinceLastUpdate) {}

function draw() {
    drawMap(c, w, thePlayer.get('x') - 5, thePlayer.get('y') - 6);
}


/** THE GAME "ENGINE" ********************************************************/
var canvas = document.getElementById("gameCanvas");
var c = canvas.getContext("2d");
var keys = {};
var rawKeys = {};
var click = null;

var UP = 38;
var DOWN = 40;
var LEFT = 37;
var RIGHT = 39;

var directions = [
    [UP, 0, -1], [DOWN, 0, 1], [LEFT, -1, 0], [RIGHT, 1, 0]
];

// Listen for key presses.
function canvasKeyDown(e) {
    keys[String.fromCharCode(e.which)] = true;
    rawKeys[e.which] = true;
}

function canvasKeyUp(e) {
    keys[String.fromCharCode(e.which)] = false;
    rawKeys[e.which] = false;
}

$('body').keydown(canvasKeyDown);
$('body').keyup(canvasKeyUp);

// Listen for clicks.
function canvasClick(e) {
    click = { "x": e.offsetX, "y": e.offsetY };
}

$('#gameCanvas').click(canvasClick);

// Set up game loop.
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
var lastUpdate = new Date().getTime();

function nextFrame() {
    var currentTime = new Date().getTime();
    input(currentTime - lastUpdate);
    click = null;
    update(currentTime - lastUpdate);
    draw();
    lastUpdate = currentTime;
    requestAnimationFrame(nextFrame);
}

// Once everything is set up, start game loop.
requestAnimationFrame(nextFrame);
        </script>
    </body>
</html>
